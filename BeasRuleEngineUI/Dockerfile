FROM node:23.1.0 AS build

WORKDIR /app

COPY package*.json ./
RUN npm install

COPY . .

ARG REACT_APP_BASE_PATH
ARG REACT_APP_OIDC_AUTHORITY
ARG REACT_APP_OIDC_AUTHORIZATION_ENDPOINT
ARG REACT_APP_OIDC_CLIENT_ID
ARG REACT_APP_OIDC_END_SESSION_ENDPOINT
ARG REACT_APP_OIDC_INTROSPECTION_ENDPOINT
ARG REACT_APP_OIDC_JWKS_URI
ARG REACT_APP_OIDC_POST_LOGOUT_REDIRECT_URI
ARG REACT_APP_OIDC_REDIRECT_URI
ARG REACT_APP_OIDC_RESPONSE_TYPE
ARG REACT_APP_OIDC_SCOPE
ARG REACT_APP_OIDC_TOKEN_ENDPOINT
ARG REACT_APP_OIDC_USERINFO_ENDPOINT

RUN echo "REACT_APP_BASE_PATH=${REACT_APP_BASE_PATH}" > .env && \
    echo "REACT_APP_OIDC_AUTHORITY=${REACT_APP_OIDC_AUTHORITY}" >> .env && \
    echo "REACT_APP_OIDC_AUTHORIZATION_ENDPOINT=${REACT_APP_OIDC_AUTHORIZATION_ENDPOINT}" >> .env && \
    echo "REACT_APP_OIDC_CLIENT_ID=${REACT_APP_OIDC_CLIENT_ID}" >> .env && \
    echo "REACT_APP_OIDC_END_SESSION_ENDPOINT=${REACT_APP_OIDC_END_SESSION_ENDPOINT}" >> .env && \
    echo "REACT_APP_OIDC_INTROSPECTION_ENDPOINT=${REACT_APP_OIDC_INTROSPECTION_ENDPOINT}" >> .env && \
    echo "REACT_APP_OIDC_JWKS_URI=${REACT_APP_OIDC_JWKS_URI}" >> .env && \
    echo "REACT_APP_OIDC_POST_LOGOUT_REDIRECT_URI=${REACT_APP_OIDC_POST_LOGOUT_REDIRECT_URI}" >> .env && \
    echo "REACT_APP_OIDC_REDIRECT_URI=${REACT_APP_OIDC_REDIRECT_URI}" >> .env && \
    echo "REACT_APP_OIDC_RESPONSE_TYPE=${REACT_APP_OIDC_RESPONSE_TYPE}" >> .env && \
    echo "REACT_APP_OIDC_SCOPE=${REACT_APP_OIDC_SCOPE}" >> .env && \
    echo "REACT_APP_OIDC_TOKEN_ENDPOINT=${REACT_APP_OIDC_TOKEN_ENDPOINT}" >> .env && \
    echo "REACT_APP_OIDC_USERINFO_ENDPOINT=${REACT_APP_OIDC_USERINFO_ENDPOINT}" >> .env

RUN npm run build

FROM nginx:alpine

COPY --from=build /app/build /usr/share/nginx/html
RUN  rm /etc/nginx/conf.d/default.conf
COPY nginx.conf /etc/nginx/conf.d/default.conf

EXPOSE 80

CMD ["nginx", "-g", "daemon off;"]
